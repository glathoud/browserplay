<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>Hashfiddle</title>
    <style type="text/css">
      body {
      font-family: helvetica; 
      font-family: Verdana,Arial,'Lucida Grande',Sans-Serif;
      }
      .hafi section { border: solid 1px black; padding: 1em; margin: 0.2em; background-color: lightgrey; }
      @media screen and (min-width: 1000px) {
      .hafi .small { font-size: small; }
      .hafi section.half { width: calc(50% - 3em); }
      .hafi .left { float: left; }
      .hafi .right { float: right; }
      .hafi .clear { clear: both; }
      }
      .hafi .top-right { position: fixed; top: 0; right: 0; margin: 0; padding: 0.5em; background-color: white; opacity: 0.9; border-radius: 0 0 0 0.33em; }
      .hafi textarea { width: 100%; min-height: 300px; }
      .hafi button { cursor: pointer; }
      .hafi #tajscompil { min-width: 58%; }
      .hafi #tajscompil.error { color: darkred; }
      .hafi .hftabcont { display: flex; flex-wrap: wrap; }
      .hafi .hftabcont>div { display: none; order: 1; }
      .hafi .hftabcont>h2 { border: 0; margin: 0.35em 0 0.6em 0; padding: 0; }
      .hafi .hftabcont>h2 label {
      display: inline-block;
      margin-right: 1.5em;
      cursor: pointer;
      font-size: 80%;
      font-weight: normal;
      }
      .hafi .hftabcont>h2 label:hover { color: darkgrey; text-decoration: underline; }
      .hafi .hftabcont>input[type="radio"] { position: absolute; left: -9999px; visibility: hidden; display: none; }
      .hafi .hftabcont>input[type="radio"]:checked+h2 label { text-decoration: underline; }
      .hafi .hftabcont>input[type="radio"]:checked+h2+div { display: block; width: 100%; }
    </style>
  </head>
  <body>

    <h1>Hashfiddle</h1>

    <div class="hafi">
      <div class="top-right">
        [<a href="#" onclick="document.body.firstElementChild.scrollIntoView();return false">top</a>]
        &ensp;[<a href="#" onclick="hafi_edit.scrollIntoView();return false">edit</a>]
        &ensp;[<a href="#" onclick="location.href='?'+Date.now()+'#o=9Y';return false">clear</a>]
      </div>
    </div>
    
    <script type="text/javascript">
      function show_fun() {
      location.href="?" + Date.now() + "#o=YKjsK8KvarZhZQZ'!spanZstyleQ%5CKborder8ZsolidZ1pxZblackJZpadding8Z2pxJZdisplay8Zinline-blockJ%5CKq'ZWZtahtml.valueZWZ'!9spanq'J%5Cntahtml.valueZQZ'5'WhW'X'WhW'H'JK7";
    }</script>
    <section>Minimalistic "web fiddler" that saves everything to the URL hash. <a href="#" onclick="show_fun()">Fun</a> within <a href="https://stackoverflow.com/questions/417142/what-is-the-maximum-length-of-a-url-in-different-browsers" target="_blank">limits</a>. Inspired from Cesium's <a href="https://cesiumjs.org/Cesium/Build/Apps/Sandcastle/" target="_blank">Sandcastle</a> &amp; <a href="https://jsfiddle.net" target="_blank">JSFiddle</a>. By <a href="http://glat.info">G. Lathoud</a>, May 2018. GitHub&nbsp;<a href="https://github.com/glathoud/hashfiddle" target="_blank">source</a>.</section>

    
    <hr style="clear: both;"/>

    <style type="text/css" id="csscont"></style>
    <div id="htmlcont"></div>

    <hr style="clear: both;"/>
    <div id="outcont"></div>

    <div class="hafi" id="hafi_edit">
    
      <section class="half right">
        <div class="hftabcont">
          <input class="hfhc" id="hfhtml" type="radio" name="hfhc" autocomplete="off" checked="checked"/>
          <h2><label for="hfhtml">html</label></h2>
          <div><textarea id="tahtml"></textarea></div>
          <input class="hfhc" id="hfcss" type="radio" name="hfhc" autocomplete="off"/>
          <h2><label for="hfcss">css</label></h2>
          <div><textarea id="tacss"></textarea></div>
          <input class="hfhc" id="hfstate" type="radio" name="hfhc" autocomplete="off"/>
          <h2><label for="hfstate">state</label></h2>
          <div><textarea id="tastate"></textarea></div>

          <script type="text/javascript">
            function show_example_with_state() {
            location.href="?" + Date.now() + "#o=YKjcK8KspanXpaddingXdisplayXtmpXreplaceXborderXinlineXXstateWWJ%5Cn%5CnvarZhZQZ'5!~%5CKZstyleQ%5CK~Y8ZsolidZ1pxZblackJZ~Z8Z2pxJZ~J8Z~H-blockJ%5CKq%23!9~%5CKqX!~%5CKZstyleQ%5CK~Y8ZsolidZ1pxZblackJZ~Z8Z2pxJZ~J8Z~H-blockJ%5CKq%23!9~%5CKqH'%5CnXZZ~QZQZh%5CnJ%5CnforZ(varZnZQZstateJZn--JZ)%5CnZZ~QZQZh.~X(Z9%239gXZ~QZ)J%5Cn%5Cn~QZQZ~Q.~X(9%239gX'')J%5Cnoutcont.inner%5DTMLZQZ~QJ%5CnKXKstateK8K0K7";
            }
            function show_bug_report() {
            location.href="?" + Date.now() + "#o=YKjcK8KlayerControlXtileLayerXfunctionXkittenXmin%20oomXTileLayerXlayer_12XvarXplacekittenXreturnXcheck_zoomXlayerGroupXmapXnew_zXlayer_3%26Xlayer_%26Xlayer_3Xlayer_2Xget%20oomXlayer_1XcoordsXlayersX%22ittenXX~WZ~VXZ~%5CKJ%5Cn%5CnL.~Y.~EZQZL.~Y.extend(Y%5Cn~1getTileUrl8Z~J(~I)ZY%5Cn~5~WZiZQZMath.ceil(ZMath.random()Z*Z%26Z)J%5Cn~5~WZkZQZ1Z!!Z~I.z%5Cn~5~-Z%5CKhttps899~!.com9%5CKZWZkZWZ%5CK9%5CKZWZkZWZ%5CK%3FimageQ%5CKZWZiJ%5Cn~17X%5Cn~1getAttribution8Z~J()ZY%5Cn~5~-Z%5CK!aZhrefQ'https899~!.com9attribution.html'qPlace~E!9aq%5CK%5Cn~17%5Cn7)J%5Cn%5CnL.~Z.~QZQZ~J(ZoptZ)ZY%5Cn~1~-ZnewZL.~Y.~E(ZnullXZoptZ)J%5Cn7%5Cn%5Cn%5Cn~WZ~MZQZL.~Z.~Q(Y~X807)J%5Cn~WZ~RZQZL.~Z.~Q(Y~X8107)J%5Cn~WZ~LZQZL.~Z.~Q(Y~X807)J%5Cn~WZ~BZQZL.~Z.~Q(Y~X8107)J%5Cn%5Cn~WZ~HZQZL.~G(5~MX~RH)J%5Cn~WZ~NZQZL.~G(5~LX~BH)J%5Cn%5Cn99Zstart%5Cn%5Cn~VZQZL.~V('~Vid'XZYZ~A8Z5Z~HHZ7).setView(5%5B1.%5B0%5BXZ-0.0%2FHXZ%5B)J%5Cn%5Cn~%5CKZQZL.control.~A(Y128~HX3%268~N7)J%5Cn~%5CK.addTo(~V)J%5Cn%5Cn~WZzZQZ~V.~O()J%5Cn%5Cn~V.on('baselayerchange'XZ~UZ)J%5Cn%5Cn~JZ~U()ZY%5Cn~1~WZ~FZQZ~V.~O()J%5Cn~1ifZ(zZ%3CQQZ~F)%5Cn~5alert(Z'~VZzoomZchangedZfromZ'ZWZzZWZ'ZtoZ'ZWZ~FZ)J%5Cn7%5Cn%5Cn~%5CK.getContainer().classList.add('clickme')KXKhcK8KleafletXcrossoriginXintegrityXsha%5B12XscriptXXZ!linkZrelQ%5CKstylesheet%5CKZhrefQ%5CKhttps899unpkg.com9~%5CK61.3.19dist9~%5CK.css%5CK~1~JQ%5CK~Q-Rksm%5BRenBE%22S%22FjgI3a%261vrjkw%26EVPl%3B3WOiI%40%5BvTjIdo%2FbrlAacEu%22Oi%3D%5BOFh%7DcOI1bkDwL%3EdLw3%20g0cR%3BAA%3DQQ%5CKZ~ZQ%5CK%5CK9q%5Cn%5CnZ!~XZsrcQ%5CKhttps899unpkg.com9~%5CK61.3.19dist9~%5CK.js%5CKZ~JQ%5CK~Q-9Nsx%2F%2C%26%5DebavoBvEBuyp3I%7Dod%5BtA0UzAxsWj%3A3%22gC%3APU0kgB%26%2Ci%22%26Lfe%26y%26cgBtaR%3B%3DEIFC%2BWoC%5B0%40aPT2L1zwQQ%5CKZ~ZQ%5CK%5CKq!9~Xq%5Cn%5CnZ!divZidQ%5CKmapid%5CKq!9divqKXKcssK8K%23mapidZYZheight8Z%2600pxJZwidth8Z100%25JZ7%5Cn%5Cn.clickme8beforeZYZcontent8Z%5CKclickZmeZqqq%5CKJZfloat8leftJ%5Cnmargin-left8Z-100%25JZbackground-color8ZwhiteJZpadding8Z0.33emJZborder-radius8Z0.33emJ%5Cn7K7";
            }
          </script>
          <span class="small" style="display: flex; align-items: center;">Example:&nbsp;<a href="#" onclick="show_example_with_state();return false">use state</a>.&nbsp;<a href="#" onclick="show_bug_report();return false" style="color: transparent">example of Leaflet bug</a></span>
        </div>
      </section>

      <section class="half left">
        <p>js (press F5 or <button onclick="location.reload()">this</button> to run) <input type="text" id="tajscompil" class="right" readonly="readonly"></input></p>
        <textarea id="tajs"></textarea>
      </section>

      <section class="clear">
        <p>Myself:</p>
        <pre><code id="myself_code"></code></pre>
      </section>

    </div>      

    <script type="text/javascript" id="myself">
    /*
      Hashfiddle - Copyright Guillaume Lathoud 2018
      
      Boost Software License - Version 1.0 - August 17th, 2003

      Permission is hereby granted, free of charge, to any person or organization
      obtaining a copy of the software and accompanying documentation covered by
      this license (the "Software") to use, reproduce, display, distribute,
      execute, and transmit the Software, and to prepare derivative works of the
      Software, and to permit third-parties to whom the Software is furnished to
      do so, all subject to the following:

      The copyright notices in the Software and this entire statement, including
      the above license grant, this restriction and the following disclaimer,
      must be included in all copies of the Software, in whole or in part, and
      all derivative works of the Software, unless such copies or derivative
      works are solely in the form of machine-executable object code generated by
      a source language processor.

      THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
      IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
      FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT
      SHALL THE COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE
      FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN CONTRACT, TORT OR OTHERWISE,
      ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
      DEALINGS IN THE SOFTWARE.
    */

    (function () {

        var w = window
        ,   tahtml      = w.tahtml
        ,   tacss       = w.tacss
        ,   tastate     = w.tastate
        ,   tajs        = w.tajs
        ,   tajscompil  = w.tajscompil
        ,   htmlcont    = w.htmlcont
        ,   myself      = w.myself
        ,   myself_code = w.myself_code

        ,   map_swap
        ,     c_swap
        ;

        prepare_mappings();
        
        // Read
        
        var h = (location.hash.match( /[#&]o=([^&]+)/ )  ||  [])[ 1 ]
        , o
        ;
        try { o = h  &&  JSON.parse( map_swap( decodeURIComponent( h ) ) ); }
        catch (e) { o = {}; }
        var html  = maybe_decompress( o, 'html', 'hc' )
        ,   css   = maybe_decompress( o, 'css', 'cc' )
        ,   state = maybe_decompress( o, 'state', 'sc' )
        ,   js    = maybe_decompress( o, 'js', 'jc' )
        ;
        function maybe_decompress( o, a, b )
        {
            var tmp;
            return !o  ?  ''  :
                (tmp = o[ a ])  &&  tmp
                || (tmp = o[ b ])  &&  decompress( o[ b ] )
                ||  ''
            ;
        }
        tahtml.value = html;
        tacss.value = css;
        tastate.value = state;
        tajs.value = js;
        htmlcont.innerHTML = html;

        // UX: show the first non-empty tab
        if (!html)
        {
            if (css)
                w.hfcss.checked=true;

            else if (state)
                w.hfstate.checked=true;
        }

        
        // issue#1: try to support script tags (simply copying the
        // tags' HTML does not seem to do much).  Reload needed on
        // modifications (e.g. F5).

        var tmp = document.createElement( 'div' );
        tmp.innerHTML = html;
        tmp.querySelectorAll( 'script' ).forEach( function (s) {
            document.write( s.outerHTML );
        } );
        
        // Write

        setInterval( update_html, 250 );

        setInterval( update_css, 250 );

        setInterval( update_hash, 333 );

        setInterval( update_jscompil, 678 );
        
        myself_code.innerHTML = myself.textContent;

        // Run

        update_html();
        update_css();
        
        document.write( '\x3Cscript type="text/javascript"\x3E' + js_with_state( js, state ) + '\x3C/script\x3E' );

        // --- Details

        var _last_html;
        function update_html()
        {
            var html = tahtml.value;
            if (_last_html !== html)
                htmlcont.innerHTML = _last_html = html;
        }

        var _last_css;
        function update_css()
        {
            var css = tacss.value;
            if (_last_css !== css)
                csscont.innerHTML = _last_css = css;
        }
        
        var _last_js_hash
        ,   _last_html_hash
        ,   _last_css_hash
        ,   _last_state_hash
        ;
        function update_hash()
        {
            var  js = tajs  .value
            ,  html = tahtml.value
            ,   css = tacss .value
            , state = tastate.value
            ;
            if (_last_js_hash !== js  ||  _last_html_hash !== html  ||  _last_css_hash !== css  ||  _last_state_hash !== state)
            {
                _last_js_hash    = js;
                _last_html_hash  = html;
                _last_css_hash   = css;
                _last_state_hash = state;

                var o = {};
                maybe_compress( o, 'js', 'jc', js );
                maybe_compress( o, 'html', 'hc', html );
                maybe_compress( o, 'css', 'cc', css );
                maybe_compress( o, 'state', 'sc', state );
                function maybe_compress( o, a, b, data )
                {
                    if (data.length)
                    {
                        var dc = compress( data );
                        if (dc.length < data.length)
                            o[ b ] = dc;
                        else
                            o[ a ] = data;
                    }
                }
                                
                var json = JSON.stringify( o )
                ,  new_h = '#o=' + encodeURIComponent( map_swap( json ) )
                ;
                if (new_h !== location.hash)
                    location.hash = new_h;
            }
        }

        var _last_js_compiled;
        function update_jscompil()
        {
            var state = tastate.value
            ,    js_0 = tajs.value
            ,    js   = js_with_state( js_0, state )
            ;
            if (_last_js_compiled !== js)
            {
                _last_js_compiled = js;
                try
                {
                    new Function( js );
                    tajscompil.classList.remove( 'error' );
                    tajscompil.value = "Compiles successfully.";
                }
                catch( e )
                {
                    tajscompil.classList.add( 'error' );
                    tajscompil.value = 'Caught error:\n' + e + '\n';
                }
            }
        }
        
        function js_with_state( js, state )
        {
            return 'var state = (' + (state  ||  'null') + ');'
                + '\n' + js
                + '\ntastate.value = state == null  ?  ""  :  JSON.stringify( state );'
            ;
        }

        // --- Further details

        var _special_code
        ,   _special
        ,   _free1arr
        ,   _free1n
        ;
        function prepare_mappings()
        {
            // 34 and 92 commented out/changed because " and \ not so great in the JSON  (optimization)          
            var code_stat = {
                32: 2792816, 33: 8171, /*34: 7154,*/ 34: 4567890, 35: 2758, 36: 1397, 37: 352, 38: 8811, 39: 45803
                , 40: 80602, 41: 80634, 42: 71490, 43: 14952, 44: 75229, 45: 10845, 46: 155503, 47: 58524, 48: 30034, 49: 16345
                , 50: 14248, 51: 16891, 52: 8485, 53: 5747, 54: 4770, 55: 3255, 56: 4920, 57: 2951, 58: 20921, 59: 87920
                , 60: 11078, 61: 78475, 62: 9894, 63: 1947, 64: 22329, 65: 25567, 66: 16495, 67: 51968, 68: 27686, 69: 27605
                , 70: 15384, 71: 12600, 72: 6850, 73: 24887, 74: 2209, 75: 1445, 76: 16495, 77: 22039, 78: 16415, 79: 20327
                , 80: 33647, 81: 2351, 82: 19126, 83: 39028, 84: 39367, 85: 10987, 86: 13960, 87: 7409, 88: 2863, 89: 3018
                , 90: 1459, 91: 19621, /*92: 289494,*/ 93: 19598, 94: 201, 95: 34534, 96: 1341, 97: 381051, 98: 65944, 99: 184773
                , 100: 185359, 101: 707877, 102: 124193, 103: 89603, 104: 145288, 105: 406223, 106: 13386, 107: 22760
                , 108: 228397, 109: 144448, 110: 613519, 111: 361289, 112: 150150, 113: 8334, 114: 431309, 115: 296987
                , 116: 526252, 117: 174585, 118: 71741, 119: 44454, 120: 44997, 121: 79435, 122: 9719, 123: 46196
                , 124: 6330, 125: 46186, 126: 226
            };

            var arr1 = [], arr2 = [];
            for (var k in code_stat)
            {
                var c = +k
                ,   v = code_stat[ k ]
                ,   s = String.fromCharCode( c )
                ;
                (s === encodeURIComponent( s )  ?  arr1  :  arr2)
                    .push( { code : c, v : v } )
                ;
            }
            arr1.sort( function ( a, b ) { return a.v-b.v; } );
            arr2.sort( function ( a, b ) { return b.v-a.v; } );

            // We'll use `_special_code` to compress spaces.
            _special_code = arr1.shift().code;
            _special = String.fromCharCode( _special_code );

            var o_swap = {};
            c_swap = {};
            for (var i = 0, ni = Math.min( arr1.length, arr2.length );
                 i < ni; ++i)
            {
                var cv1 = arr1[ i ]
                ,   cv2 = arr2[ i ]
                ;
                if (cv2.v < cv1.v)
                    break;
                
                var code1 = cv1.code
                ,   code2 = cv2.code
                ;
                o_swap[ code2 ] = code1;
                o_swap[ code1 ] = code2;

                var char1 = String.fromCharCode( code1 )
                ,   char2 = String.fromCharCode( code2 )
                ;
                c_swap[ char1 ] = char2;
                c_swap[ char2 ] = char1;
            }
            map_swap = mapperGen( o_swap );

            // We'll use `_special_code` and `_free1arr` to compress words.
            var set36 = {};
            Array.apply( null, {length: 36} ).forEach( function (_,x) { set36[ x.toString( 36 ) ] = true; } )
            ;
            _free1arr = [];
            arr1.forEach( function (o) {
                var c = String.fromCharCode( o.code );
                if (!set36[ c ])
                    _free1arr.push( c );
            });
            _free1n = _free1arr.length;
            
            function mapperGen( o )
            {
                return mapper;
                function mapper( s )
                {
                    var n = s.length
                    , arr = new Array( n )
                    ;
                    for (var i = 0; i < n; ++i)
                    {
                        var code_in = s.charCodeAt( i )
                        ,   tmp     = o[ code_in ]
                        ;
                        arr[ i ]    = tmp != null  ?  tmp  :  code_in;
                    }
                    return String.fromCharCode.apply( String, arr );  // Hopefully won't reach the engine limit here
                }
            }
        }

        function compress( js )
        {
            var n_of_w = {};
            (js.match( /\b\w+\b/g )  ||  [])
                .forEach( function (w) { if (w.length > 2) n_of_w[ w ] = 1 + (n_of_w[ w ]  ||  0); } )
            ;
            var wa = Object.keys( n_of_w ).map( function (w) {
                var n = n_of_w[ w ];
                return { w : w, n : n, gain : n * (w.length - 2) - /*the head list cost:*/(w.length + 1) };
            });
            wa = wa
                .filter( function (o) { return o.gain > 0; })
                .sort( function (a,b) { return b.gain - a.gain; } )
                .slice( 0, _free1n )
            ;
            var c_of_w = {};
            wa.forEach( function (o, i) { c_of_w[ o.w ] = _free1arr[ i ] } );

            var word_regexp = wa.length  &&  new RegExp(
                wa.map( function (o) { return o.w; } ).join( '|' )
                , 'g'
            );

            var head = wa.map( function (o) { return o.w; } ).join(',') + ',,'
            ,   body = js
                .replace( new RegExp( '\\' + _special, 'g' ), _special + _special )
                .replace( / {3,38}/g, cfs )
            ;
            if (wa.length > 0)
                body = body.replace( word_regexp, cfw );
            
            return head + body;
            
            function cfw( w )
            {
                var tmp = c_of_w[ w ];
                tmp.length === 1  ||  null.bug;
                return _special + map_swap( c_of_w[ w ] );  // (c_swap[ tmp ]  ||  tmp);  // faster than map_swap for a single char
            }
            
            function cfs( s )
            {
                return _special + map_swap( (s.length - 3).toString( 36 ) );
            }
        }

        function decompress( js )
        {
            var head = js.match( /^(.*?),,/ )[ 1 ]
            ,   body = js.substring( 2 + head.length )

            ,   wa = head.split( ',' )
            , w_of_c = {}
            ;
            wa.forEach( function (w,i) { w_of_c[ _free1arr[ i ] ] = w } );

            return body.replace( new RegExp( '\\' + _special + '(.)', 'g' )
                                 , df
                               );

            function df( a, b_0 )
            {
                b_0.length === 1  ||  null.bug;
                var b = map_swap( b_0 );
                return b === _special  ?  a
                    :  b in w_of_c  ?  w_of_c[ b ]
                    :  ' '.repeat( 3 + parseInt( b, 36 ) );
            }
        }
        
    })();
    </script>

    <script type="text/javascript" src="ga.js"></script>

  </body>
</html>
