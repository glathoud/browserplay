<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>Hashfiddle</title>
    <style type="text/css">
      body {
      font-family: helvetica; 
      font-family: Verdana,Arial,'Lucida Grande',Sans-Serif;
      }


      .hafi section { border: solid 1px black; padding: 1em; margin: 0.2em; background-color: lightgrey; }
      .hafi .top-right { position: fixed; top: 0; right: 0; margin: 0; z-index: 99999; padding: 0.5em; background-color: white; opacity: 0.9; border-radius: 0 0 0 0.33em; }
      .hafi .lglh { height: 1.4em; }
      .hafi textarea { width: 100%; min-height: 300px; }
      .hafi button { cursor: pointer; }
      .hafi #tajscompil { min-width: 58%; }
      .hafi #tajscompil.error { color: darkred; }
      .hafi .hftabcont { display: flex; flex-wrap: wrap; }
      .hafi .hftabcont>div { display: none; order: 1; }
      .hafi .hftabcont>p label {
      display: inline-block;
      margin-right: 1em;
      cursor: pointer;
      font-size: larger;
      }
      .hafi .hftabcont>p label:hover { color: darkgrey; text-decoration: underline; }
      .hafi .hftabcont>input[type="radio"] { position: absolute; left: -9999px; visibility: hidden; display: none; }
      .hafi .hftabcont>input[type="radio"]:checked+p label { text-decoration: underline; font-weight: bold; }
      .hafi .hftabcont>input[type="radio"]:checked+p+div { display: block; width: 100%; }

      @media screen and (max-width: 999px) {
      body { font-size: 1.4em; }
      pre, button { font-size: 1.6em; }
      .hafi { width: calc( 100% - 4em ); }
      .hafi textarea { min-height: 450px; }
      }
      @media screen and (min-width: 1000px) {
      .hafi .small { font-size: small; }
      .hafi section.half { width: calc(50% - 3em); }
      .hafi .left { float: left; }
      .hafi .right { float: right; }
      .hafi .clear { clear: both; }
      }

    </style>
  </head>
  <body>

    <div class="hafi">

      <h1>Hashfiddle</h1>

      <script type="text/javascript">
        function load_url_hash( h ) {
        location.href='?'+Date.now().toString(36)+'#'+h.substring(/^#/.test(h)?1:0);
        return false;
        }
      </script>
      
      <div class="top-right">
        [<a href="#" onclick="document.body.firstElementChild.scrollIntoView();return false">top</a>]
        &ensp;[<a href="#" onclick="hafi_edit.scrollIntoView();return false">edit</a>]
        &ensp;[<a href="#" onclick="return load_url_hash('#o=76')">clear</a>]
      </div>
      
      <span>Minimalistic "web fiddler" that saves everything to the URL hash. <a href="#" class="hafi-a-fun">Fun</a> within <a href="https://stackoverflow.com/questions/417142/what-is-the-maximum-length-of-a-url-in-different-browsers" target="_blank">limits</a>. Inspired from Cesium's <a href="https://cesiumjs.org/Cesium/Build/Apps/Sandcastle/" target="_blank">Sandcastle</a> &amp; <a href="https://jsfiddle.net" target="_blank">JSFiddle</a>. By&nbsp;<a href="http://glat.info">G.&nbsp;Lathoud</a>, May&nbsp;2018. GitHub&nbsp;<a href="https://github.com/glathoud/hashfiddle" target="_blank">source</a>.</span>
      
      <hr style="clear: both;"/>
    </div >
      
    <style type="text/css" id="csscont"></style>
    <div id="htmlcont"></div>
    <div id="outcont"></div>

    <div class="hafi">
      <hr style="clear: both;"/>
      <div id="hafi_edit">
        
        <section class="half right">
          <div class="hftabcont">
            <input class="hfhc" id="hfhtml" type="radio" name="hfhc" autocomplete="off" checked="checked"/>
            <p class="lglh"><label for="hfhtml">html</label></p>
            <div><textarea id="tahtml"></textarea></div>
            <input class="hfhc" id="hfcss" type="radio" name="hfhc" autocomplete="off"/>
            <p><label for="hfcss">css</label></p>
            <div><textarea id="tacss"></textarea></div>
            <input class="hfhc" id="hfstate" type="radio" name="hfhc" autocomplete="off"/>
            <p><label for="hfstate">state</label></p>
            <div><textarea id="tastate"></textarea></div>

            <span class="small" style="display: flex; align-items: center;">Examples:&nbsp;<a href="#" class="hafi-a-fun">use html</a>,&nbsp;<a href="#" class="hafi-a-state">use state</a>,&nbsp;<a href="#" class="hafi-a-gui-toggle">toggle GUI</a>,&nbsp;<a href="#" class="hafi-a-game-of-life">game of life</a>,&nbsp;<a href="#" class="hafi-a-leaflet-bug-report">Leaflet bug</a>.</span>
          </div>
        </section>

        <section class="half left">
          <p class="lglh">js (press F5 or <button class="in-text" onclick="location.reload()">this</button> to run) <input type="text" id="tajscompil" class="in-text right" readonly="readonly"></input></p>
          <textarea id="tajs"></textarea>
        </section>

      </div>      
    </div>      

    <script type="text/javascript">
(function () {

  setup_example_anchor( ".hafi-a-fun", "#o=7KjsK5KvarJhJXJ'qspanJstyleXZKborder5JsolidJ1pxJblackQJpadding5J2pxQJdisplay5Jinline-blockQZK4'J!Jtahtml.valueJ!J'qYspan4'QZntahtml.valueJXJ'H'!h!'9'!h!'W'QK6" );

  setup_example_anchor( ".hafi-a-state", "#o=7KjcK5Kspan9padding9display9tmp9replace9border9inline99state!!QZnZnvarJhJXJ'Hq~ZKJstyleXZK~95JsolidJ1pxJblackQJ~ZZ5J2pxQJ~J5J~Y-blockQZK4%23qY~ZK49q~ZKJstyleXZK~95JsolidJ1pxJblackQJ~ZZ5J2pxQJ~J5J~Y-blockQZK4%23qY~ZK4W'Zn9JJ~QJXJhZnQZnforJ(varJnJXJstateQJn--QJ)ZnJJ~QJXJh.~X(JY%23Yg9J~QJ)QZnZn~QJXJ~Q.~X(Y%23Yg9'')QZnoutcont.inner%5BTMLJXJ~QQZnK9KstateK5K0K6" );

  setup_example_anchor( ".hafi-a-gui-toggle", "#o=7KhcK5Kbutton9toggle99q~ZKJonclickXZKdocument.body.classList.~ZZ('hafi-hidden')ZK4~ZZJhashfiddleJGUIJvisibilityqY~ZK4K9KccK5Khafi9hidden99.~ZK-~ZZ.~ZK9J.~ZK-~ZZJ.~ZKJ7Jdisplay5JnoneQJ6ZnK6" );

  setup_example_anchor( ".hafi-a-game-of-life", "#o=7Kj3K5K99YYJConway'sJGameJofJLifeJinJaJtoreJworldZnYYJBuiltJusingJhttp5YYglat.infoYhafiZnZnvarJinputJXJhtmlcont.textContentZn9~1rowsJXJinput.split(J'ZZn'J)Zn9~0nrowJJXJrows.lengthZn9~0ncolJJXJrows.reduce(J(a9b)JX4JMath.max(a9b.length)9J0J)ZnQZnconsole.log('nrow9ncol5'9nrow9ncol)QZnZntahtml.valueJXJrows.map(Jget_new_rowJ).join(J'ZZn'J)QZnZnYYJ---JDetailsZnZnfunctionJget_new_row(Jold_row9JiJ)J7ZnZnJJreturnJold_rowZn~1.padEnd(JncolJ)Zn~1.split(J''J)Zn~1.map(Jget_new_colJ)Zn~1.join('')QZnZnJJfunctionJget_new_col(Jc9JjJ)J7ZnZn~1varJis_aliveJXJcJ%2BXXJ'J'Zn~19~0nn_aliveJXJget_n_neighbour_alive(Ji9JjJ)Zn~1Zn~1YYJRuleJbasedJon5Zn~1YYJhttps5YYen.wikipedia.orgYwikiYConway%252{s_Game_of_LifeZn~19~0new_is_aliveJXJis_aliveZn~3%3FJJnn_aliveJXXXJ2JJ||JJnn_aliveJXXXJ3~0YYJsurvivalZn~35JJnn_aliveJXXXJ3JJYYJbirthZn~1QZn~1returnJnew_is_aliveJJ%3FJJ'x'JJ5JJ'J'QZnJJ6ZnZnJJfunctionJget_n_neighbour_alive(Ji9JjJ)J7ZnZn~1varJretJXJ0QZnZn~1forJ(varJi2JXJi-1QJi2JqXJi!1QJi2!!)J7ZnZn~3forJ(varJj2JXJj-1QJj2JqXJj!1QJj2!!)J7ZnZn~5ifJ(i2JXXXJiJJ%26%26JJj2JXXXJj)JZn~7continueQZnJZn~5YYJtoreJworldZn~5varJi3JXJ(i2J!Jnrow)J%25JnrowZn~59~0j3JXJ(j2J!Jncol)J%25JncolZn~59JneighbourJXJ(rowsHJi3JWJJ||JJ'').charAt(Jj3J)Zn~5QZn~5ifJ(neighbourJJ%26%26JJneighbourJ%2BXXJ'J')Zn~7ret!!QZn~36JZn~16ZnZn~1returnJretQZnJJ6Zn6ZnK9Kh3K5K99~7~7~7~7~7~7~7~0Zn~7~7~7~7~7~7~7ZnZnZnZn~7~7~7~7~7~7~7Zn~7~7~7~7~7~7~7Zn~7~7~7~7~7~7~7Zn~7~5Zn~7~7~7~1xxxZn~7~7~7~2xZnZn~7~7~7Zn~7~6Zn~7~7~7~5Zn~7~7~7~7~7~7~7Zn~7~7~7~7~7~7~7Zn~7~7~7~7~7~7~7Zn~7~7~7~7~7~7~7Zn~7~7~7~7~7~7~7Zn~7~7~7~7~7~7~7K9KcssK5K%23htmlcontJ7Jwhite-space5JpreQJfont-family5JmonospaceQJborder5JsolidJ1pxJblackQJdisplay5Jinline-blockQJ6K6" );

  setup_example_anchor( ".hafi-a-leaflet-bug-report", "#o=7KjcK5KlayerControl9tileLayer9function9check_zoom9kitten9min%5Coom9TileLayer9baselayerchange9layer_129var9placekitten9layerGroup9map9return9layer_3>9new_z9layer_39layer_>9layer_29layer_19get%5Coom9layers9coords9\x22itten99~WJ~z9J~ZKQZnZnL.~Y.~OJXJL.~Y.extend(7Zn~1getTileUrl5J~J(~R)J7Zn~5~WJiJXJMath.ceil(JMath.random()J*J>J)QZn~5~WJkJXJ1JqqJ~R.zZn~5~-JZKhttps5YY~!.comYZKJ!JkJ!JZKYZKJ!JkJ!JZK%3FimageXZKJ!JiQZn~169Zn~1getAttribution5J~J()J7Zn~5~-JZKqaJhrefX'https5YY~!.comYattribution.html'4Place~OqYa4ZKZn~16Zn6)QZnZnL.~ZZ.~XJXJ~J(JoptJ)J7Zn~1~-JnewJL.~Y.~O(Jnull9JoptJ)QZn6ZnZnZn~WJ~NJXJL.~ZZ.~X(7~9506)QZn~WJ~FJXJL.~ZZ.~X(7~95106)QZn~WJ~jJXJL.~ZZ.~X(7~9506)QZn~WJ~VJXJL.~ZZ.~X(7~95106)QZnZn~WJ~HJXJL.~q(H~N9~FW)QZn~WJ~UJXJL.~q(H~j9~VW)QZnZnYYJstartZnZn~zJXJL.~z('~zid'9J7J~L5JHJ~HWJ6).setView(H%3A1.%3A0%3A9J-0.0%2CW9J%3A)QZnZn~ZKJXJL.control.~L(7125~H93>5~U6)QZn~ZK.addTo(~z)QZnZn~WJzJXJ~z.~B()QZnZn~z.on('~8'9J~QJ)QZnZn~JJ~Q()J7Zn~1~WJ~GJXJ~z.~B()QZn~1ifJ(zJ%2BXXJ~G)J7Zn~5~z.off('~8'9J~Q)QZn~5alert(J'~zJzoomJchangedJfromJ'J!JzJ!J'JtoJ'J!J~GJ)QZn~16Zn6ZnZn~ZK.getContainer().classList.add('clickme')K9KhcK5Kleaflet9crossorigin9integrity9sha%3A129script99qlinkJrelXZKstylesheetZKJhrefXZKhttps5YYunpkg.comY~ZK81.3.1YdistY~ZK.cssZKZn~0~JXZK~Q-Rksm%3ARenBE\x22S\x22FjgI3a>1vrjkw>EVPl%203!OiI%7D%3AvTjIdo%2CbrlAacEu\x22Oi%3B%3AOFh%7BcOI1bkDwL<dLw3%5Cg0cR%20AA%3BXXZKZn~0~ZZXZKZKY4ZnZnJq~XJsrcXZKhttps5YYunpkg.comY~ZK81.3.1YdistY~ZK.jsZKJ~JXZK~Q-YNsx%2C%3D>%5BebavoBvEBuyp3I%7Bod%3AtA0UzAxs!j%403\x22gC%40PU0kgB>%3Di\x22>Lfe>y>cgBtaR%20%3BEIFC%5D!oC%3A0%7DaPT2L1zwXXZKJ~ZZXZKZK4qY~X4ZnZnJqdivJidXZKmapidZK4qYdiv4K9KcssK5K%23mapidJ7Jheight5J>00pxQJwidth5J100%25QJ6ZnZn.clickme5beforeJ7Jcontent5JZKclickJmeJ444ZKQJfloat5leftQZnmargin-left5J-100%25QJbackground-color5JwhiteQJpadding5J0.33emQJborder-radius5J0.33emQZn6K6" );
      
  function setup_example_anchor( css_sel, href ) {
    document.querySelectorAll( css_sel ).forEach( function ( node ) { node.setAttribute( 'href', '?_' + (Date.now() + Math.random()).toString(16) + href ); } );
  }

})();
    </script>



    <script type="text/javascript" id="myself">
    /*
      Hashfiddle - Copyright Guillaume Lathoud 2018
      
      Boost Software License - Version 1.0 - August 17th, 2003

      Permission is hereby granted, free of charge, to any person or organization
      obtaining a copy of the software and accompanying documentation covered by
      this license (the "Software") to use, reproduce, display, distribute,
      execute, and transmit the Software, and to prepare derivative works of the
      Software, and to permit third-parties to whom the Software is furnished to
      do so, all subject to the following:

      The copyright notices in the Software and this entire statement, including
      the above license grant, this restriction and the following disclaimer,
      must be included in all copies of the Software, in whole or in part, and
      all derivative works of the Software, unless such copies or derivative
      works are solely in the form of machine-executable object code generated by
      a source language processor.

      THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
      IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
      FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT
      SHALL THE COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE
      FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN CONTRACT, TORT OR OTHERWISE,
      ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
      DEALINGS IN THE SOFTWARE.
    */

    (function () {

        var w = window
        ,   tahtml      = w.tahtml
        ,   tacss       = w.tacss
        ,   tastate     = w.tastate
        ,   tajs        = w.tajs
        ,   tajscompil  = w.tajscompil
        ,   htmlcont    = w.htmlcont
        ,   myself      = w.myself

        // A number from 1 to 36, not too high to have better words compression.
        // Watch out: if you change this value, the whole encoding changes.
        ,   SPACE_N = 8

        ,   map_swap

        ,   HASH_RX = /([#&]o=)([^&]+)/
        ;

        prepare_mappings();

        function compress_name_arr_js()     { return [ 'js',    'jc', 'j2', 'j3' ]; }
        function compress_name_arr_html()   { return [ 'html',  'hc', 'h2', 'h3' ]; }
        function compress_name_arr_css()    { return [ 'css',   'cc', 'c2', 'c3' ]; }
        function compress_name_arr_state()  { return [ 'state', 'sc', 's2', 's3' ]; }
                
        // Read
        
        var h = (location.hash.match( HASH_RX )  ||  [])[ 2 ]
        , o
        ;
        try { o = h  &&  JSON.parse( map_swap( decodeURIComponent( h ) ) ); }
        catch (e) { o = {}; }
        var js    = maybe_decompress( o, compress_name_arr_js() )
        ,   html  = maybe_decompress( o, compress_name_arr_html() )
        ,   css   = maybe_decompress( o, compress_name_arr_css() )
        ,   state = maybe_decompress( o, compress_name_arr_state() )
        ;       
        tahtml.value = html;
        tacss.value = css;
        tastate.value = state;
        tajs.value = js;
        htmlcont.innerHTML = html;

        // UX: show the first non-empty tab
        if (!html)
        {
            if (css)
                w.hfcss.checked=true;

            else if (state)
                w.hfstate.checked=true;
        }

        
        // issue#1: try to support script tags (simply copying the
        // tags' HTML does not seem to do much).  Reload needed on
        // modifications (e.g. F5).

        var tmp = document.createElement( 'div' );
        tmp.innerHTML = html;
        tmp.querySelectorAll( 'script' ).forEach( function (s) {
            document.write( s.outerHTML );
        } );

        read_editor_status();

        // Write

        setInterval( update_html, 250 );

        setInterval( update_css, 250 );

        document.addEventListener( 'keypress', hash_remember_last_keypress );
        document.addEventListener( 'mouseover', hash_remember_doc_mouseover );
        document.addEventListener( 'mouseleave', hash_remember_doc_mouseleave );
        window.addEventListener( 'popstate', hash_detect_user_browsing_history );
        setInterval( update_hash, 421 );

        setInterval( update_jscompil, 678 );

        setInterval( store_editor_status, 356 );

        // Run

        update_html();
        update_css();
        
        document.write( '\x3Cscript type="text/javascript"\x3E' + js_with_state( js, state ) + '\x3C/script\x3E' );

        update_hash();  // In case the user is "iterating" by pressing F5 very soon.

        // --- Details

        var _last_html;
        function update_html()
        {
            var html = tahtml.value;
            if (_last_html !== html)
                htmlcont.innerHTML = _last_html = html;
        }

        var _last_css;
        function update_css()
        {
            var css = tacss.value;
            if (_last_css !== css)
                csscont.innerHTML = _last_css = css;
        }
        
        var _last_js_hash
        ,   _last_html_hash
        ,   _last_css_hash
        ,   _last_state_hash

        ,   _last_keypress
        ,   _last_doc_mouseout

        ,   _last_h_part
        ;

        function hash_remember_last_keypress()
        {
            _last_keypress = Date.now();
        }

        function hash_remember_doc_mouseover()
        {
            _last_doc_mouseout = false;
        }

        function hash_remember_doc_mouseleave()
        {
            _last_doc_mouseout = true;
        }

        function hash_detect_user_browsing_history()
        // Convenience: automatic reload when browser history changed by the
        // user.
        {
            var mo = _last_doc_mouseout !== false  &&  _last_h_part  &&  (HASH_RX.exec( location.hash )  ||  ['']);
            if (mo  &&  mo[ 0 ].substring(1) !== 'o=' + _last_h_part)
                location.reload();  
        }

        function update_hash()
        {
            // Not the first time  &&  user currently typing
            if (_last_js_hash != null  &&  500 > Date.now() - _last_keypress)
                return;   // This way the browser history GUI remains somewhat usable
    
            var  js = tajs  .value
            ,  html = tahtml.value
            ,   css = tacss .value
            , state = tastate.value
            ;
            if (_last_js_hash !== js  ||  _last_html_hash !== html  ||  _last_css_hash !== css  ||  _last_state_hash !== state)
            {
                _last_js_hash    = js;
                _last_html_hash  = html;
                _last_css_hash   = css;
                _last_state_hash = state;

                var o = {};
                maybe_compress( o, compress_name_arr_js(),    js );
                maybe_compress( o, compress_name_arr_html(),  html );
                maybe_compress( o, compress_name_arr_css(),   css );
                maybe_compress( o, compress_name_arr_state(), state );

                var json = JSON.stringify( o )
                ,  old_h = location.hash  ||  '#'
                ;
                if (!HASH_RX.test( old_h ))
                    old_h += (old_h.length > 1  ?  '&'  :  '') + 'o=_';

                _last_h_part = encodeURIComponent( map_swap( json ) );
                
                HASH_RX.test( old_h )  ||  null.bug;
                var new_h = old_h.replace( HASH_RX, '$1' + _last_h_part );

                // Update the hash... but not too often, so that the
                // browser history GUI remains somewhat usable.
                if (new_h !== old_h)
                    location.hash = new_h;
                
                // Also make the browser history GUI slightly more expressive

                document.title = [ htmlcont.textContent
                                   , outcont.textContent
                                   , tajs.value
                                   , tahtml.value
                                   , tacss.value
                                   , tastate.value
                                 ]
                    .filter( function ( x ) { return x; } )
                    .map( function ( x ) { return x.length < 33  ?  x  :  x.substring( 0, 30 ) + '...' } )
                    .join( ' | ' )
                    ||  'Hashfiddle'
                ;
            }
        }

        var _last_js_compiled;
        function update_jscompil()
        {
            var state = tastate.value
            ,    js_0 = tajs.value
            ,    js   = js_with_state( js_0, state )
            ;
            if (_last_js_compiled !== js)
            {
                _last_js_compiled = js;
                try
                {
                    new Function( js );
                    tajscompil.classList.remove( 'error' );
                    tajscompil.value = "Compiles successfully.";
                }
                catch( e )
                {
                    tajscompil.classList.add( 'error' );
                    tajscompil.value = 'Caught error:\n' + e + '\n';
                }
            }
        }
        
        function js_with_state( js, state )
        {
            return 'var state = (' + (state  ||  'null') + ');'
                + '\n' + js
                + '\ntastate.value = state == null  ?  ""  :  JSON.stringify( state );'
            ;
        }



        function read_editor_status()
        {
            var storage = editor_storage()
            ,   hf = storage  &&  storage.hashfiddle
            ,   hfo
            ;
            try { hfo = hf  &&  JSON.parse( hf ); } catch (e) { delete storage.hashfiddle; hfo = null; }

            var act = hfo  &&  hfo.active
            ,   id = act  &&  act.id
            , node = id  &&  document.getElementById( id )
            ,   ch = hfo  &&  hfo.ch
            ;
            if (node)
            {
                node.focus();
                var s0 = act.s0
                ,   s1 = act.s1
                ;
                if (s0 != null)   node.selectionStart = s0;
                if (s1 != null)   node.selectionEnd   = s1;
            }
            if (ch)
            {
                for (var id in ch)
                {
                    var node = document.getElementById( id );
                    if (node)
                        node.checked = !!ch[ id ];
                }
            }

        }

        function store_editor_status()
        {
            var storage = editor_storage();
            if (storage)
            {
                var daE = document.activeElement
                ,    id = daE  &&  /^textarea$/i.test( daE.tagName )  &&  daE.id
                ,    s0 = id  &&  daE.selectionStart
                ,    s1 = id  &&  daE.selectionEnd
                ,    ch = {}
                ;
                if (id  &&  daE !== tajs)
                {
                    [].forEach.call(document.querySelectorAll('input[type="radio"], input[type="checkbox"]')
                                    , store_one
                                   );
                }

                function store_one(x)
                {
                    var id = x.id;
                    if (id  &&  x.checked)
                    {
                        var ta = document.getElementById("ta"+id.substring(2));
                        if (ta  &&  !/^\s*$/.test( ta.value ))
                            ch[ id ] = true;
                    }
                }
                
                var to_store = { active : id  &&  { id : id, s0 : s0, s1 : s1 } ||  null
                                 , ch : ch
                               };
                storage.hashfiddle = JSON.stringify( to_store );
            }
        }

        // --- Further details

        var _storage_supported, _storage;
        function editor_storage( candidate_arr )
        {
            if (_storage_supported != null)
                return _storage_supported  &&  _storage;

            if (!candidate_arr)
            {
                return editor_storage( [ window.localStorage
                                         , window.sessionStorage
                                       ] );
            }

            if (candidate_arr.length < 1)
                return (_storage_supported = false);
            
            var candidate = candidate_arr.shift();
            try
            {
                delete candidate.__test_hafi__
                candidate.__test_hafi__ = '123';
                if (candidate.__test_hafi__ === '123')
                {
                    delete candidate.__test_hafi__;
                    _storage_supported = true;
                    return (_storage = candidate);
                }
            }
            catch( e )
            {
                
            }

            return editor_storage( candidate_arr );
        }


        var _special_code
        ,   _special
        ,   _free1arr
        ,   _free1n
        ,   _sarr1
        ,   _sarr1n
        ;
        function prepare_mappings()
        {
            // 34 and 92 changed (to bigger values) because " and \ not so great in the JSON  (optimization)          
            var code_stat = {
                32: 2792816, 33: 8171
                , /*34: 7154, changed to: */ 34: 9999999
                , 35: 2758, 36: 1397, 37: 352, 38: 8811, 39: 45803
                , 40: 80602, 41: 80634, 42: 71490, 43: 14952, 44: 75229, 45: 10845, 46: 155503, 47: 58524, 48: 30034, 49: 16345
                , 50: 14248, 51: 16891, 52: 8485, 53: 5747, 54: 4770, 55: 3255, 56: 4920, 57: 2951, 58: 20921, 59: 87920
                , 60: 11078, 61: 78475, 62: 9894, 63: 1947, 64: 22329, 65: 25567, 66: 16495, 67: 51968, 68: 27686, 69: 27605
                , 70: 15384, 71: 12600, 72: 6850, 73: 24887, 74: 2209, 75: 1445, 76: 16495, 77: 22039, 78: 16415, 79: 20327
                , 80: 33647, 81: 2351, 82: 19126, 83: 39028, 84: 39367, 85: 10987, 86: 13960, 87: 7409, 88: 2863, 89: 3018
                , 90: 1459, 91: 19621
                , /*92: 289494, changed to: */ 92: 9999999
                , 93: 19598, 94: 201, 95: 34534, 96: 1341, 97: 381051, 98: 65944, 99: 184773
                , 100: 185359, 101: 707877, 102: 124193, 103: 89603, 104: 145288, 105: 406223, 106: 13386, 107: 22760
                , 108: 228397, 109: 144448, 110: 613519, 111: 361289, 112: 150150, 113: 8334, 114: 431309, 115: 296987
                , 116: 526252, 117: 174585, 118: 71741, 119: 44454, 120: 44997, 121: 79435, 122: 9719, 123: 46196
                , 124: 6330, 125: 46186, 126: 226
            };

            var arr1 = [], arr2 = [];
            for (var k in code_stat)
            {
                var c = +k
                ,   v = code_stat[ k ]
                ,   s = String.fromCharCode( c )
                ;
                (s === encodeURIComponent( s )  ?  arr1  :  arr2)
                    .push( { code : c, v : v, s : s } )
                ;
            }

            // impl. note: `a.code-b.code` necessary to fully determine sort order
            // (otherwise cross-browser differences)
            arr1.sort( function ( a, b ) { return a.v-b.v  ||  a.code-b.code; } );  
            arr2.sort( function ( a, b ) { return b.v-a.v  ||  a.code-b.code; } );
            
            // We'll use `_special_code` to compress spaces.
            _special_code = arr1.shift().code;
            _special = String.fromCharCode( _special_code );

            _sarr1  = arr1.map( function (x) { return x.s; } );
            _sarr1n = _sarr1.length;
            
            // console.log('_special_code:',_special_code,', arr1:', arr1, ', arr2:', arr2);
            
            var o_swap = {};
            for (var i = 0, ni = Math.min( arr1.length, arr2.length );
                 i < ni; ++i)
            {
                var cv1 = arr1[ i ]
                ,   cv2 = arr2[ i ]
                ;
                if (cv2.v < cv1.v)
                    break;
                
                var code1 = cv1.code
                ,   code2 = cv2.code
                ;
                o_swap[ code2 ] = code1;
                o_swap[ code1 ] = code2;
            }
            map_swap = mapperGen( o_swap );

            // We'll use `_special_code` and `_free1arr` to compress words.
            var setSpace = {};
            Array.apply( null, {length: SPACE_N} ).forEach( function (_,x) { setSpace[ x.toString( SPACE_N ) ] = true; } )
            ;
            _free1arr = [];
            arr1.forEach( function (o) {
                var c = String.fromCharCode( o.code );
                if (!setSpace[ c ])
                    _free1arr.push( c );
            });
            _free1n = _free1arr.length;

            // console.log('_free1arr:', _free1arr);
            
            function mapperGen( o )
            {
                return mapper;
                function mapper( s )
                {
                    var      n = s.length
                    , is_short = n < 20
                    ,      ret = is_short  &&  mapper[ s ]
                    ;
                    if (!ret)
                    {
                        var arr = new Array( n );
                        for (var i = 0; i < n; ++i)
                        {
                            var code_in = s.charCodeAt( i )
                            ,   tmp     = o[ code_in ]
                            ;
                            arr[ i ]    = tmp != null  ?  tmp  :  code_in;
                        }
                        ret = sFromCharCode( arr );

                        if (is_short)
                            mapper[ s ] = ret;
                    }
                    return ret;
                }
            }
        }

        
        function maybe_compress( o, name_arr, data_0 )
        {
            if (data_0.length > 0)
            {
                // no compression
                var best_comp = name_arr[ 0 ] 
                ,   best_data = data_0
                ;
                for (var i = 1, i_end = name_arr.length;
                     i < i_end; ++i)
                {
                    // some compression (depends on i, where i>0)

                    var comp = name_arr[ i ]
                    ,   data = compress( data_0, i )
                    ;
                    if (comp.length + data.length < best_comp.length + best_data.length)
                    {
                        // pick the shortest one
                        best_comp = comp;
                        best_data = data;
                    }
                }

                o[ best_comp ] = best_data;
            }
        }
        
        function maybe_decompress( o, name_arr )
        {
            if (o)
            {
                for (var i = name_arr.length; i--;)
                {
                    var tmp = o[ name_arr[ i ] ];
                    if (tmp)
                    {
                        return i < 1
                            ?  tmp                    // no compression
                            :  decompress( tmp, i )   // some compression
                        ;
                    }
                }
            }
            
            return '';
        }

        
        function compress( /*string*/js, /*number of characters after the `_special` character*/nc )
        {
            js.substring.call.a;
            nc > 0  &&  nc === nc | 0  && nc.toPrecision.call.a;

            var nmax = nmax_of_nc[ nc ]  ||  nmax_of_nc( nc );
            
            var n_of_w = {};

            // Performance note: this part ran faster in Chrome
            // using `forEach` as compared to inline code (2018-06).
            (js.match( /\b\w+\b/g )  ||  []).forEach( function (w) {
                if (w.length > 2)
                    n_of_w[ w ] = 1 + (n_of_w[ w ] | 0);
            });
            

            // Performance note: this part ran faster as inline code,
            // as compared to map/filter chains (Chrome, 2018-06).
            var wa = [];
            for (var w in Object.keys( n_of_w ))
            {
                var  n = n_of_w[ w ]
                , gain = n * (w.length - (1+nc)) - /*the head list cost:*/(w.length + 1)
                ;
                if (gain > 0)
                    wa.push( { w : w, n : n, gain : gain } );

                if (wa.length === nmax)
                    break;
            }
            wa.sort( function (a,b) { return b.gain - a.gain; } );

            var wa_n = wa.length;
            
            var s_of_w = {}
            ,   w_arr  = new Array( wa_n )
            ;
            for (var i = wa.length; i--;)
            {
                var o = wa[ i ]
                ,   w = w_arr[ i ] = o.w
                ;
                s_of_w[ w ] = word_code( nc, i );
            }
            
            var word_regexp = wa.length
                &&  new RegExp( w_arr.join( '|' ), 'g' );
            
            var head = w_arr.join(',') + ',,'

            ,   body = js
                .replace( new RegExp( '\\' + _special, 'g' ), _special + _special )
                .replace( new RegExp( ' {3,' + (2 + SPACE_N) + '}', 'g' ), cfs )
            ;
            if (wa.length > 0)
                body = body.replace( word_regexp, cfw );

            return head + body;

            // Implementation note: we pre-swap here, so that after
            // the final swap, each character in the URL will be the
            // desired ones == no ugly %XX encoding == only 1 char.
            //
            // Additionally we try the cache first `map_swap[ tmp ]`
            // for better performance.
            
            function cfw( w )
            {
                var tmp = s_of_w[ w ];
                return _special + (map_swap[ tmp ]  ||  map_swap( tmp ));
            }
            
            function cfs( s )
            {
                var tmp = (s.length - 3).toString( SPACE_N );
                return _special + (map_swap[ tmp ]  ||  map_swap( tmp ));
            }
        }

        function decompress( /*string*/js, /*number*/nc )
        {
            js.substring.call.a;
            nc > 0  &&  nc === nc | 0  && nc.toPrecision.call.a;

            var head = js.match( /^(.*?),,/ )[ 1 ]
            ,   body = js.substring( 2 + head.length )

            ,     wa = head.split( ',' )
            , w_of_s = {}
            ;
            wa.forEach( function (w,i) {
                w_of_s[ word_code( nc, i ) ] = w;
            } );

            // Implementation note: we need to swap again because of
            // the pre-swap done in `compress()`, see above.
            //
            // Additionally we try the cache first `map_swap[ tmp ]`
            // for better performance.
            
            var rx_space_part = Array.apply( null, { length : SPACE_N } )
                .map( function( _, i ) {
                    var tmp = i.toString( SPACE_N );
                    return map_swap[ tmp ]  ||  map_swap( tmp );
                } )
                .join( '' )

            ,   rx_str = '\\' + _special + '('
                + '[' + rx_space_part + ']' 
                + '|[^\\' + _special + rx_space_part + ']' + (nc < 2  ?  ''  :  '(?:[^\\' + _special + ']{' + (nc-1) + ',' + (nc-1) + '})')
                + ')'

            ,   rx = new RegExp( rx_str, 'g' )
            ;
            return body.replace( rx, df );

            function df( a, b_0 )
            {
                var b = map_swap[ b_0 ]  ||  map_swap( b_0 );
                
                var n = b.length;
                n === 1  ||  n === nc  ||  null.bug;

                return b in w_of_s     ?  w_of_s[ b ]
                    :  n !== 1         ?  null.bug
                    :  b === _special  ?  a
                    :  ' '.repeat( 3 + parseInt( b, SPACE_N ) )
                ;
            }
        }

        
        function word_code(
            /*integer (number of characters after the `_special` characters)*/nc
            , /*number*/i_0 )
        {
            var cache = word_code[ nc ]  ||  (word_code[ nc ] = [])
            ,   ret   = cache[ i_0 ]
            ;
            if (!ret)
            {            
                var dim_arr = dim_arr_of_nc[ nc ]  ||  dim_arr_of_nc( nc );
                
                for (var k = dim_arr.length, tmp = new Array( k ), i = i_0;
                     k--;)
                {
                    var  dim = dim_arr[ k ]
                    ,  c_arr =
                        dim === _free1n  ?  _free1arr
                        :  dim === _sarr1n  ?  _sarr1
                        :  null.bug
                    ;
                    c_arr.length === dim  ||  null.bug;

                    tmp[ k ] = c_arr[ i % dim ];
                    i = (i / dim) | 0;
                }
                
                i === 0  ||  null.bug;
                tmp.length === nc  ||  null.bug;

                ret = cache[ i_0 ] = tmp.join( '' );
            }
            ret.length === nc  ||  null.bug;
            return ret;
        }

        
        function nmax_of_nc( /*integer (number of characters after the `_special` characters)*/nc )
        {
            return nmax_of_nc[ nc ]  ||  (nmax_of_nc[ nc ] = dim_arr_of_nc( nc ).nmax);
        }
            
        function dim_arr_of_nc( /*integer (number of characters after the `_special` characters)*/nc )
        {
            var ret = dim_arr_of_nc[ nc ];
            if (!ret)
            {
                ret = dim_arr_of_nc[ nc ] =
                    Array
                    .apply( null, { length: nc } )
                    .map( function ( _, i ) { return i < 1  ?  _free1n  :  _sarr1n; } )
                
                ret.nmax = ret.reduce( function ( a, b ) { return a*b; } );
            }
            return ret;                
        }
        


        function sFromCharCode( /*array of integer*/arr )
        {
            // Summary: should be safe with big arrays
            // Loosely inspired by http://webreflection.blogspot.com/2011/07/about-javascript-apply-arguments-limit.html
            
            var n   = arr.length
            , p     = 20000
            , s_arr = []
            ;
            if (arr.subarray) // TypedArray
            {
                for (var i = 0; i < n; i += p)
                    s_arr.push( String.fromCharCode.apply( String, arr.subarray( i, i + p ) ) );
            }
            else
            {
                for (var i = 0; i < n; i += p)
                    s_arr.push( String.fromCharCode.apply( String, arr.slice( i, i + p ) ) );
            }
            
            return s_arr.join('');
        }

        
    })();
    </script>

    <script type="text/javascript" src="ga.js"></script>

  </body>
</html>
