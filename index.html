<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <title>browserplay</title>
    <style type="text/css">
      .browserplay section { border: solid 1px black; padding: 1em; margin: 0.2em; background-color: lightgrey; }
      .browserplay section.half { width: calc(50% - 3em); }
      .browserplay .left { float: left; }
      .browserplay .right { float: right; }
      .browserplay .clear { clear: left; }
      .browserplay textarea { width: 100%; min-height: 300px; }
      .browserplay #tajscompil { min-width: 66%; }
      .browserplay #tajscompil.error { color: darkred; }
      .browserplay .bptabcont { display: flex; flex-wrap: wrap; }
      .browserplay .bptabcont>div { display: none; order: 1; }
      .browserplay .bptabcont>h2 { border: 0; margin: 0.35em 0 0.6em 0; padding: 0; }
      .browserplay .bptabcont>h2 label {
      display: inline-block;
      margin-right: 1.5em;
      cursor: pointer;
      font-size: 80%;
      font-weight: normal;
      }
      .browserplay .bptabcont>h2 label:hover { color: darkgrey; text-decoration: underline; }
      .browserplay .bptabcont>input[type="radio"] { position: absolute; left: -9999px; visibility: hidden; display: none; }
      .browserplay .bptabcont>input[type="radio"]:checked+h2 label { text-decoration: underline; }
      .browserplay .bptabcont>input[type="radio"]:checked+h2+div { display: block; width: 100%; }
    </style>
  </head>
  <body>

    <h1>browserplay</h1>

    <aside style="float: right">by <a href="http://glat.info">G. Lathoud</a>, May 2018.</aside>

    <script type="text/javascript">
      function show_fun() {
      location.href="?" + Date.now() + "#o=9\x22html\x226\x22\x22Q\x22css\x226\x22\x22Q\x22js\x226\x22varKhKJK'WspanKstyleJ%5C\x22border6KsolidK1pxKblackZKpadding6K2pxZKdisplay6Kinline-blockZ%5C\x22!'KHKtahtml.valueKHK'WXspan!'Z%5Cntahtml.valueKJK'8'HhH'Q'HhH'5'Z\x22Y";
    }</script>
    <section><a href="#" onclick="show_fun()">Fun</a> within <a href="https://stackoverflow.com/questions/417142/what-is-the-maximum-length-of-a-url-in-different-browsers" target="_blank">limits</a>.</section>

    
    <hr style="clear: left;"/>

    <style type="text/css" id="csscont"></style>
    <div id="htmlcont"></div>

    <hr/>

    <div class="browserplay">
    
      <section class="half right">
        <div class="bptabcont">
          <input class="bphc" id="bphtml" type="radio" name="bphc" autocomplete="off" checked="checked"/>
          <h2><label for="bphtml">html</label></h2>
          <div><textarea id="tahtml"></textarea></div>
          <input class="bphc" id="bpcss" type="radio" name="bphc" autocomplete="off"/>
          <h2><label for="bpcss">css</label></h2>
          <div><textarea id="tacss"></textarea></div>
        </div>
      </section>

      <section class="half left">
        <p>js (F5 to run) <input type="text" id="tajscompil" class="right" readonly="readonly"></input></p>
        <textarea id="tajs"></textarea>
      </section>

      <section class="clear">
        <p>Myself:</p>
        <pre><code id="myself_code"></code></pre>
      </section>

    </div>      

    <script type="text/javascript" id="myself">
    /*
      Boost Software License - Version 1.0 - August 17th, 2003

      Permission is hereby granted, free of charge, to any person or organization
      obtaining a copy of the software and accompanying documentation covered by
      this license (the "Software") to use, reproduce, display, distribute,
      execute, and transmit the Software, and to prepare derivative works of the
      Software, and to permit third-parties to whom the Software is furnished to
      do so, all subject to the following:

      The copyright notices in the Software and this entire statement, including
      the above license grant, this restriction and the following disclaimer,
      must be included in all copies of the Software, in whole or in part, and
      all derivative works of the Software, unless such copies or derivative
      works are solely in the form of machine-executable object code generated by
      a source language processor.

      THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
      IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
      FITNESS FOR A PARTICULAR PURPOSE, TITLE AND NON-INFRINGEMENT. IN NO EVENT
      SHALL THE COPYRIGHT HOLDERS OR ANYONE DISTRIBUTING THE SOFTWARE BE LIABLE
      FOR ANY DAMAGES OR OTHER LIABILITY, WHETHER IN CONTRACT, TORT OR OTHERWISE,
      ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
      DEALINGS IN THE SOFTWARE.
    */

    (function () {

        var w = window
        ,   tahtml      = w.tahtml
        ,   tacss       = w.tacss
        ,   tajs        = w.tajs
        ,   tajscompil  = w.tajscompil
        ,   htmlcont    = w.htmlcont
        ,   myself      = w.myself
        ,   myself_code = w.myself_code

        ,   map_swap
        ,     c_swap
        ;

        prepare_mappings();
        
        // Read
        
        var h = (location.hash.match( /[#&]o=([^&]+)/ )  ||  [])[ 1 ]
        , o = h  &&  JSON.parse( map_swap( decodeURIComponent( h ) ) )
        , html  = o  &&  o.html  ||  ''
        , css   = o  &&  o.css   ||  ''
        , o_js  = o  &&  o.js
        , o_jc  = o  &&  o.jc
        , js    = o_js  ?  o_js  :  o_jc  ?  decompress( o_jc )  :  ''
        ;
        tahtml.value = html;
        tacss.value = css;
        tajs.value = js;
        htmlcont.innerHTML = html;

        // Write

        setInterval( update_html, 250 );

        setInterval( update_css, 250 );

        setInterval( update_hash, 333 );

        setInterval( update_jscompil, 678 );
        
        myself_code.innerHTML = myself.textContent;

        // Run

        document.write( '\x3Cscript type="text/javascript"\x3E' + js + '\x3C/script\x3E' );

        // --- Details

        var _last_html;
        function update_html()
        {
            var html = tahtml.value;
            if (_last_html !== html)
                htmlcont.innerHTML = _last_html = html;
        }

        var _last_css;
        function update_css()
        {
            var css = tacss.value;
            if (_last_css !== css)
                csscont.innerHTML = _last_css = css;
        }

        var _last_js_hash
        ,   _last_html_hash
        ,   _last_css_hash
        ;
        function update_hash()
        {
            var js = tajs  .value
            , html = tahtml.value
            ,  css = tacss .value
            ;
            if (_last_js_hash !== js  ||  _last_html_hash !== html  ||  _last_css_hash !== css)
            {
                _last_js_hash   = js;
                _last_html_hash = html;
                _last_css_hash  = css;
                
                var jc = compress( js )
                ,   o  = { html : html, css : css }
                ;
                if (jc.length < js.length)
                    o.jc = jc;
                else
                    o.js = js;
                
                var json = JSON.stringify( o )
                ,  new_h = '#o=' + encodeURIComponent( map_swap( json ) )
                ;
                if (new_h !== location.hash)
                    location.hash = new_h;
            }
        }

        var _last_js_compiled;
        function update_jscompil()
        {
            var js = tajs.value;
            if (_last_js_compiled !== js)
            {
                _last_js_compiled = js;
                try
                {
                    new Function( js );
                    tajscompil.classList.remove( 'error' );
                    tajscompil.value = "Compiles successfully.";
                }
                catch( e )
                {
                    tajscompil.classList.add( 'error' );
                    tajscompil.value = 'Caught error:\n' + e + '\n';
                }
            }
        }

        // --- Further details

        var _special_code
        ,   _special
        ,   _free1arr
        ,   _free1n
        ;
        function prepare_mappings()
        {
            // 34 and 92 commented out because " and \ not so great in the JSON  (optimization)          
            var code_stat = {
                32: 2792816, 33: 8171, /* 34: 7154,*/ 35: 2758, 36: 1397, 37: 352, 38: 8811, 39: 45803
                , 40: 80602, 41: 80634, 42: 71490, 43: 14952, 44: 75229, 45: 10845, 46: 155503, 47: 58524, 48: 30034, 49: 16345
                , 50: 14248, 51: 16891, 52: 8485, 53: 5747, 54: 4770, 55: 3255, 56: 4920, 57: 2951, 58: 20921, 59: 87920
                , 60: 11078, 61: 78475, 62: 9894, 63: 1947, 64: 22329, 65: 25567, 66: 16495, 67: 51968, 68: 27686, 69: 27605
                , 70: 15384, 71: 12600, 72: 6850, 73: 24887, 74: 2209, 75: 1445, 76: 16495, 77: 22039, 78: 16415, 79: 20327
                , 80: 33647, 81: 2351, 82: 19126, 83: 39028, 84: 39367, 85: 10987, 86: 13960, 87: 7409, 88: 2863, 89: 3018
                , 90: 1459, 91: 19621, /*92: 289494,*/ 93: 19598, 94: 201, 95: 34534, 96: 1341, 97: 381051, 98: 65944, 99: 184773
                , 100: 185359, 101: 707877, 102: 124193, 103: 89603, 104: 145288, 105: 406223, 106: 13386, 107: 22760
                , 108: 228397, 109: 144448, 110: 613519, 111: 361289, 112: 150150, 113: 8334, 114: 431309, 115: 296987
                , 116: 526252, 117: 174585, 118: 71741, 119: 44454, 120: 44997, 121: 79435, 122: 9719, 123: 46196
                , 124: 6330, 125: 46186, 126: 226
            };

            var arr1 = [], arr2 = [];
            for (var k in code_stat)
            {
                var c = +k
                ,   v = code_stat[ k ]
                ,   s = String.fromCharCode( c )
                ;
                (s === encodeURIComponent( s )  ?  arr1  :  arr2)
                    .push( { code : c, v : v } )
                ;
            }
            arr1.sort( function ( a, b ) { return a.v-b.v; } );
            arr2.sort( function ( a, b ) { return b.v-a.v; } );

            // We'll use `_special_code` to compress spaces.
            _special_code = arr1.shift().code;
            _special = String.fromCharCode( _special_code );

            var o_swap = {};
            c_swap = {};
            for (var i = 0, ni = Math.min( arr1.length, arr2.length );
                 i < ni; ++i)
            {
                var cv1 = arr1[ i ]
                ,   cv2 = arr2[ i ]
                ;
                if (cv2.v < cv1.v)
                    break;
                
                var code1 = cv1.code
                ,   code2 = cv2.code
                ;
                o_swap[ code2 ] = code1;
                o_swap[ code1 ] = code2;

                var char1 = String.fromCharCode( code1 )
                ,   char2 = String.fromCharCode( code2 )
                ;
                c_swap[ char1 ] = char2;
                c_swap[ char2 ] = char1;
            }
            map_swap = mapperGen( o_swap );

            // We'll use `_special_code` and `_free1arr` to compress words.
            var set36 = {};
            Array.apply( null, {length: 36} ).forEach( function (_,x) { set36[ x.toString( 36 ) ] = true; } )
            ;
            _free1arr = [];
            arr1.forEach( function (o) {
                var c = String.fromCharCode( o.code );
                if (!set36[ c ])
                    _free1arr.push( c );
            });
            _free1n = _free1arr.length;
            
            function mapperGen( o )
            {
                return mapper;
                function mapper( s )
                {
                    var n = s.length
                    , arr = new Array( n )
                    ;
                    for (var i = 0; i < n; ++i)
                    {
                        var code_in = s.charCodeAt( i )
                        ,   tmp     = o[ code_in ]
                        ;
                        arr[ i ]    = tmp != null  ?  tmp  :  code_in;
                    }
                    return String.fromCharCode.apply( String, arr );  // Hopefully won't reach the engine limit here
                }
            }
        }

        function compress( js )
        {
            var n_of_w = {};
            (js.match( /\b\w+\b/g )  ||  [])
                .forEach( function (w) { if (w.length > 2) n_of_w[ w ] = 1 + (n_of_w[ w ]  ||  0); } )
            ;
            var wa = Object.keys( n_of_w ).map( function (w) {
                var n = n_of_w[ w ];
                return { w : w, n : n, gain : n * (w.length - 2) - /*the head list cost:*/(w.length + 1) };
            });
            wa = wa
                .filter( function (o) { return o.gain > 0; })
                .sort( function (a,b) { return b.gain - a.gain; } )
                .slice( 0, _free1n )
            ;
            var c_of_w = {};
            wa.forEach( function (o, i) { c_of_w[ o.w ] = _free1arr[ i ] } );

            var word_regexp = wa.length  &&  new RegExp(
                wa.map( function (o) { return o.w; } ).join( '|' )
                , 'g'
            );

            var head = wa.map( function (o) { return o.w; } ).join(',') + ',,'
            ,   body = js
                .replace( new RegExp( '\\' + _special, 'g' ), _special + _special )
                .replace( / {3,38}/g, cfs )
            ;
            if (wa.length > 0)
                body = body.replace( word_regexp, cfw );
            
            return head + body;
            
            function cfw( w )
            {
                var tmp = c_of_w[ w ];
                tmp.length === 1  ||  null.bug;
                return _special + map_swap( c_of_w[ w ] );  // (c_swap[ tmp ]  ||  tmp);  // faster than map_swap for a single char
            }
            
            function cfs( s )
            {
                return _special + map_swap( (s.length - 3).toString( 36 ) );
            }
        }

        function decompress( js )
        {
            var head = js.match( /^(.*?),,/ )[ 1 ]
            ,   body = js.substring( 2 + head.length )

            ,   wa = head.split( ',' )
            , w_of_c = {}
            ;
            wa.forEach( function (w,i) { w_of_c[ _free1arr[ i ] ] = w } );

            return body.replace( new RegExp( '\\' + _special + '(.)', 'g' )
                                 , df
                               );

            function df( a, b_0 )
            {
                b_0.length === 1  ||  null.bug;
                var b = map_swap( b_0 );
                return b === _special  ?  a
                    :  b in w_of_c  ?  w_of_c[ b ]
                    :  ' '.repeat( 3 + parseInt( b, 36 ) );
            }
        }
        
    })();
    </script>

    <script type="text/javascript" src="ga.js"></script>

  </body>
</html>
